name: Build and Release
on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0-beta)'
        required: true
        default: 'v1.0-beta'
      release_name:
        description: 'Release name'
        required: true
        default: 'Beta Release v1.0'
      is_beta_release:
        description: 'Mark as beta release'
        required: false
        default: true
        type: boolean
      custom_notes:
        description: 'Additional release notes (optional)'
        required: false
        default: ''
      use_custom_bootloader:
        description: 'Build with custom bootloader (reduces AV false positives)'
        required: false
        default: true
        type: boolean

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Check-out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  
         
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          architecture: 'x64'
          cache: 'pip'

      - name: Install system dependencies for bootloader compilation
        if: ${{ github.event.inputs.use_custom_bootloader == 'true' }}
        run: |
          choco install visualstudio2022-workload-vctools -y
          Import-Module $env:ChocolateyInstall\helpers\chocolateyProfile.psm1
          refreshenv
        shell: powershell

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install wheel setuptools
      
      - name: Build custom PyInstaller bootloader
        if: ${{ github.event.inputs.use_custom_bootloader == 'true' }}
        run: |
          git clone https://github.com/pyinstaller/pyinstaller.git pyinstaller-source
          cd pyinstaller-source
          
          cd bootloader
          python waf distclean all
          
          cd ..
          pip install .
          
          echo "Custom bootloader built and installed successfully"
        shell: powershell

      - name: Install standard PyInstaller
        if: ${{ github.event.inputs.use_custom_bootloader == 'false' }}
        run: |
          pip install pyinstaller
        shell: powershell

      - name: Verify PyInstaller installation
        run: |
          pyinstaller --version
          python -c "import PyInstaller; print('PyInstaller location:', PyInstaller.__path__[0])"
        shell: powershell
      
      - name: Generate executable name with version
        id: exe_name
        run: |
          $releaseTag = "${{ github.event.inputs.release_tag }}"
          $version = $releaseTag -replace '^v', '' -replace '[^a-zA-Z0-9.-]', '-'
          $exeName = "DigTool-$version"
          
          echo "exe_name=$exeName" >> $env:GITHUB_OUTPUT
          echo "Generated executable name: $exeName"
        shell: powershell
         
      - name: Build Executable with PyInstaller
        run: |
          pyinstaller --onefile --windowed --name="${{ steps.exe_name.outputs.exe_name }}" --icon=assets/icon.ico --add-data="assets;assets" --add-data="core;core" --add-data="interface;interface" --add-data="utils;utils" --collect-all=autoit --hidden-import=winrt.windows.foundation --hidden-import=winrt.windows.media.ocr --hidden-import=winrt.windows.graphics.imaging --hidden-import=winrt.windows.storage.streams --distpath=dist --workpath=build --specpath=. --clean main.py
         
      - name: Get executable info and generate verification file
        id: get_exe_info
        run: |
          $exeName = (Get-ChildItem -Path "dist" -Filter "*.exe" | Select-Object -First 1).Name
          $exePath = "dist/$exeName"
          $fileSize = [math]::Round((Get-Item $exePath).Length / 1MB, 2)
          
          $sha256Hash = (Get-FileHash -Path $exePath -Algorithm SHA256).Hash
          $md5Hash = (Get-FileHash -Path $exePath -Algorithm MD5).Hash
          
          $bootloaderType = if ("${{ github.event.inputs.use_custom_bootloader }}" -eq "true") { "Custom" } else { "Standard" }
          
          $verificationContent = "# DigTool Build Verification`n"
          $verificationContent += "# Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')`n"
          $verificationContent += "# File: $exeName`n"
          $verificationContent += "# Size: ${fileSize}MB`n`n"
          $verificationContent += "## File Integrity (Checksums)`n"
          $verificationContent += "SHA256: $sha256Hash`n"
          $verificationContent += "MD5: $md5Hash`n`n"
          $verificationContent += "### Verification Commands`n"
          $verificationContent += "Windows: certutil -hashfile $exeName SHA256`n"
          $verificationContent += "Linux/Mac: sha256sum $exeName`n`n"
          $verificationContent += "## Build Attestation`n"
          $verificationContent += "Workflow: ${{ github.workflow }}`n"
          $verificationContent += "Run ID: ${{ github.run_id }}`n"
          $verificationContent += "Run Number: ${{ github.run_number }}`n"
          $verificationContent += "Actor: ${{ github.actor }}`n"
          $verificationContent += "Repository: ${{ github.repository }}`n"
          $verificationContent += "Branch/Ref: ${{ github.ref }}`n"
          $verificationContent += "Commit SHA: ${{ github.sha }}`n"
          $verificationContent += "Timestamp: $(Get-Date -Format 'yyyy-MM-ddTHH:mm:ssZ')`n"
          $verificationContent += "Bootloader: $bootloaderType PyInstaller Bootloader`n`n"
          $verificationContent += "## Verification Links`n"
          $verificationContent += "GitHub Actions Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`n"
          $verificationContent += "Source Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}`n`n"
          $verificationContent += "## JSON Attestation`n"

          $attestation = @{
            "build_info" = @{
              "workflow" = "${{ github.workflow }}"
              "run_id" = "${{ github.run_id }}"
              "run_number" = "${{ github.run_number }}"
              "actor" = "${{ github.actor }}"
              "repository" = "${{ github.repository }}"
              "ref" = "${{ github.ref }}"
              "sha" = "${{ github.sha }}"
              "timestamp" = "$(Get-Date -Format 'yyyy-MM-ddTHH:mm:ssZ')"
              "bootloader_type" = "$bootloaderType"
            }
            "executable" = @{
              "name" = "$exeName"
              "sha256" = "$sha256Hash"
              "md5" = "$md5Hash"
              "size_mb" = "$fileSize"
            }
            "verification" = @{
              "github_actions_url" = "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              "commit_url" = "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
            }
          }
          
          $attestationJson = $attestation | ConvertTo-Json -Depth 10 -Compress:$false
          $verificationContent += $attestationJson
          
          $verificationContent | Out-File -FilePath "dist/VERIFICATION.txt" -Encoding UTF8
          
          echo "exe_name=$exeName" >> $env:GITHUB_OUTPUT
          echo "exe_path=$exePath" >> $env:GITHUB_OUTPUT
          echo "file_size=$fileSize" >> $env:GITHUB_OUTPUT
          echo "sha256_hash=$sha256Hash" >> $env:GITHUB_OUTPUT
          echo "md5_hash=$md5Hash" >> $env:GITHUB_OUTPUT
          echo "bootloader_type=$bootloaderType" >> $env:GITHUB_OUTPUT
          echo "Built executable: $exeName (${fileSize}MB) with $bootloaderType bootloader"
          echo "SHA256: $sha256Hash"
        shell: powershell
        
      - name: Create and push tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "${{ github.event.inputs.release_tag }}" -m "Release ${{ github.event.inputs.release_name }}"
          git push origin "${{ github.event.inputs.release_tag }}"
       
      - name: Generate automated release notes
        id: generate_notes
        run: |
          $releaseTag = "${{ github.event.inputs.release_tag }}"
          $isBeta = "${{ github.event.inputs.is_beta_release }}" -eq "true"
          $customNotes = "${{ github.event.inputs.custom_notes }}"
          
          $notes = ""
          
          if ($isBeta) {
            $notes += "**⚠️ BETA RELEASE ⚠️**`n`n"
            $notes += "Please report any issues within the [discord](https://discord.com/invite/mxE7dzXMGf).`n`n"
          } else {
            $notes += "Join our [Discord](https://discord.com/invite/mxE7dzXMGf) for support and updates!`n`n"
          }
          
          if ($customNotes -and $customNotes.Trim() -ne "") {
            $notes += "$customNotes`n`n"
          }
          
          $notes += "> **File Integrity Verification:** ``${{ steps.get_exe_info.outputs.sha256_hash }}```n"
          $notes += "[Build Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
         
          echo "release_notes<<EOF" >> $env:GITHUB_OUTPUT
          echo "$notes" >> $env:GITHUB_OUTPUT
          echo "EOF" >> $env:GITHUB_OUTPUT
        shell: powershell
       
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_name }}
          body: ${{ steps.generate_notes.outputs.release_notes }}
          draft: false
          prerelease: ${{ github.event.inputs.is_beta_release }}
          files: |
            ${{ steps.get_exe_info.outputs.exe_path }}
            dist/VERIFICATION.txt
         
      - name: Output release info
        run: |
          echo "Release created successfully!"
          echo "Tag: ${{ github.event.inputs.release_tag }}"
          echo "Asset: ${{ steps.get_exe_info.outputs.exe_name }}"
          echo "Full path: ${{ steps.get_exe_info.outputs.exe_path }}"
          echo "Bootloader: ${{ steps.get_exe_info.outputs.bootloader_type }}"
        shell: powershell

      - name: Cleanup build artifacts
        if: always()
        run: |
          if (Test-Path "pyinstaller-source") {
            Remove-Item -Recurse -Force "pyinstaller-source"
          }
        shell: powershell